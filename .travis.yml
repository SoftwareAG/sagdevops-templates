language: minimal
sudo: required
services:
  - docker

# os:
#   - linux
#   - osx
#   - windows

env:
  global:
    - CC_TAG=10.3
    - TAG=10.3
    - FIXES=ALL
    - REG=sergeipogrebnyak
  matrix:
    - IMAGE=universal-messaging
    - IMAGE=integration-server

stages:
  - infra
  - test
  - deploy

before_install: docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD"

script:
  - cd containers && echo "Building and testing $IMAGE:$TAG"
  - docker-compose build $IMAGE && docker-compose push $IMAGE

jobs:
  include:
    - stage: infra
      env:
        - IMAGE=none
      script: 
        - cd licenses && openssl aes-256-cbc -K $encrypted_11f35f1fe671_key -iv $encrypted_11f35f1fe671_iv -in licenses.zip.enc -out licenses.zip -d && cd ..
        - cd infrastructure && export COMPOSE_FILE="docker-compose.yml:master.yml:${TAG}.master.yml"
        - docker-compose build && docker-compose push

    - stage: deploy
      env:
        - IMAGE=none
        - NET=sagcc_default
      script: 
        - cd deployments/docker
        - docker-compose -f sag-cc/docker-compose.yml up -d
        - docker-compose -f sag-um-is-push/docker-compose.yml run --rm init
